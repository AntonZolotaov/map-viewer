<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improved Photo + KML Map Viewer</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Leaflet Marker Cluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        /* General body styling for a clean, modern look */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 2em;
            background-color: #f8f9fa;
            color: #212529;
            display: flex;
            justify-content: center;
        }
        /* Main container for the application */
        .container {
            width: 100%;
            max-width: 1000px;
            background-color: #fff;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.08);
        }
        h2 {
            text-align: center;
            color: #343a40;
            margin-bottom: 1em;
        }
        /* Controls area with file inputs */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1em;
            margin-bottom: 1.5em;
        }
        /* Styling for drag-and-drop zones */
        .drop-zone {
            padding: 1.5em;
            border: 2px dashed #adb5bd;
            border-radius: 8px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        /* Highlight effect when dragging a file over the drop zone */
        .drop-zone.drag-over {
            background-color: #e9ecef;
            border-color: #007bff;
        }
        .drop-zone p { margin: 0; font-weight: 500; color: #495057; }
        input[type="file"] { display: none; } /* Hide default file input */
        
        /* Map container styling */
        #map {
            height: 550px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5em;
        }
        /* Status message styling for user feedback */
        .status-message {
            padding: 1em;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            border: 1px solid transparent;
            margin-bottom: 1.5em;
        }
        .status-message.initial { background-color: #e9ecef; color: #495057; border-color: #ced4da; }
        .status-message.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-message.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-message.loading { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        
        /* Photo grid styling */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1.5em;
        }
        .photo-item {
            cursor: pointer;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease, outline 0.2s ease;
        }
        .photo-item:hover { transform: translateY(-5px); }
        /* Highlight effect for photo items linked to map markers */
        .photo-item.highlighted {
             outline: 3px solid #007bff;
             border-radius: 10px;
             box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }
        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .photo-item p { margin-top: 0.5em; font-size: 0.85em; color: #6c757d; }
        
        /* Action buttons styling */
        .actions { text-align: right; margin-bottom: 1em; }
        #resetButton {
            padding: 0.6em 1.2em;
            border: none;
            background-color: #dc3545;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #resetButton:hover { background-color: #c82333; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üìç Photo + KML Map Viewer - by AZW & Gemini</h2>
        
        <div class="controls">
            <!-- Drop zone for photos -->
            <label for="photoInput" id="photoDropZone" class="drop-zone">
                <p>üì∑ Drag & Drop Photos Here or Click to Select</p>
                <input type="file" id="photoInput" accept="image/*" multiple>
            </label>
            <!-- Drop zone for KML file -->
            <label for="kmlInput" id="kmlDropZone" class="drop-zone">
                <p>üó∫Ô∏è Drag & Drop KML File or Click to Select</p>
                <input type="file" id="kmlInput" accept=".kml, .KML">
            </label>
        </div>
        
        <div class="actions">
            <button id="resetButton">Clear All</button>
        </div>
        
        <div id="statusMessage" class="status-message initial">Upload photos and/or a KML file to begin.</div>
        <div id="map"></div>
        <div id="photoGrid"></div>
    </div>
    
    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/exifr/dist/lite.umd.js"></script>
    <script src="https://unpkg.com/togeojson@0.16.0/togeojson.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === DOM Element References ===
            const statusMessage = document.getElementById('statusMessage');
            const photoGrid = document.getElementById('photoGrid');
            const photoInput = document.getElementById('photoInput');
            const kmlInput = document.getElementById('kmlInput');
            const resetButton = document.getElementById('resetButton');

            // === Map Initialization ===
            const map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Create a red icon for photo markers
            const redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            // === State Management ===
            // Using MarkerClusterGroup for better performance with many markers
            let photoMarkers = L.markerClusterGroup();
            let kmlLayer = null;
            map.addLayer(photoMarkers);

            // === Core Functions ===
            const showStatus = (message, type) => {
                statusMessage.textContent = message;
                statusMessage.className = `status-message ${type}`;
            };

            const resetApp = () => {
                photoInput.value = '';
                kmlInput.value = '';
                photoMarkers.clearLayers();
                if (kmlLayer) {
                    map.removeLayer(kmlLayer);
                    kmlLayer = null;
                }
                photoGrid.innerHTML = '';
                showStatus('Upload photos and/or a KML file to begin.', 'initial');
                map.setView([20, 0], 2);
            };

            // Recalculates map bounds to fit all visible data (photos and KML)
            const updateMapBounds = () => {
                const bounds = new L.LatLngBounds();
                if (photoMarkers.getLayers().length > 0) {
                    bounds.extend(photoMarkers.getBounds());
                }
                if (kmlLayer) {
                    bounds.extend(kmlLayer.getBounds());
                }
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            };
            
            // === Photo Processing Logic ===
            const processPhotos = async (files) => {
                if (files.length === 0) return;
                showStatus(`Processing ${files.length} photos...`, 'loading');
                photoMarkers.clearLayers();
                photoGrid.innerHTML = '';
                
                let photosWithGps = 0;
                // Process files asynchronously
                const photoPromises = Array.from(files).map(async (file, index) => {
                    const url = URL.createObjectURL(file);
                    try {
                        const exif = await exifr.gps(file);
                        return { file, url, exif, id: `photo-${Date.now()}-${index}` };
                    } catch (err) {
                        console.error(`Error reading EXIF for ${file.name}:`, err);
                        return { file, url, exif: null, id: `photo-${Date.now()}-${index}` }; // Continue even if one file fails
                    }
                });

                const photoData = await Promise.all(photoPromises);

                photoData.forEach(data => {
                    const { file, url, exif, id } = data;

                    // Create photo grid item
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.id = id;
                    photoGrid.appendChild(photoItem);
                    
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = file.name;
                    photoItem.appendChild(img);
                    
                    const text = document.createElement('p');
                    photoItem.appendChild(text);

                    if (exif && exif.latitude && exif.longitude) {
                        photosWithGps++;
                        const { latitude: lat, longitude: lon } = exif;
                        text.textContent = `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;

                        // Create map marker with a photo thumbnail in the popup
                        const marker = L.marker([lat, lon], { icon: redIcon });
                        const popupContent = `<img src="${url}" width="150" alt="${file.name}" style="border-radius: 4px; margin-bottom: 5px;"><br><b>${file.name}</b>`;
                        marker.bindPopup(popupContent);
                        
                        // Link marker click to highlight the photo in the grid
                        marker.on('click', () => {
                            document.querySelectorAll('.photo-item.highlighted').forEach(el => el.classList.remove('highlighted'));
                            photoItem.classList.add('highlighted');
                            photoItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        });
                        photoMarkers.addLayer(marker);

                        // Link photo item click to pan the map to the marker
                        photoItem.addEventListener('click', () => {
                            photoMarkers.zoomToShowLayer(marker, () => {
                                marker.openPopup();
                            });
                        });

                    } else {
                        text.textContent = 'No GPS data';
                        text.style.color = '#721c24';
                    }
                });
                
                if (photosWithGps > 0) {
                    showStatus(`Successfully processed ${files.length} photos. ${photosWithGps} had GPS data.`, 'success');
                } else {
                    showStatus(`Processed ${files.length} photos, but none had GPS data.`, 'error');
                }
                updateMapBounds();
            };

            // === KML Processing Logic ===
            const processKml = (file) => {
                if (!file) return;
                showStatus('Loading KML file...', 'loading');
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const parser = new DOMParser();
                        const kml = parser.parseFromString(e.target.result, 'text/xml');
                        const geojson = toGeoJSON.kml(kml);

                        if (kmlLayer) map.removeLayer(kmlLayer);
                        kmlLayer = L.geoJSON(geojson, {
                            style: () => ({ color: '#007bff', weight: 4, opacity: 0.85 })
                        }).addTo(map);

                        showStatus('KML file loaded successfully!', 'success');
                        updateMapBounds();

                    } catch (err) {
                        console.error('Error processing KML file:', err);
                        showStatus('Could not parse KML file. Please check its format.', 'error');
                    }
                };

                reader.onerror = () => showStatus('Error reading KML file.', 'error');
                reader.readAsText(file);
            };

            // === Event Listeners ===
            photoInput.addEventListener('change', e => processPhotos(e.target.files));
            kmlInput.addEventListener('change', e => processKml(e.target.files[0]));
            resetButton.addEventListener('click', resetApp);
            
            // Drag and Drop functionality
            ['photoDropZone', 'kmlDropZone'].forEach(zoneId => {
                const zone = document.getElementById(zoneId);
                const input = zoneId === 'photoDropZone' ? photoInput : kmlInput;

                zone.addEventListener('dragover', e => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                zone.addEventListener('dragleave', e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                });
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        input.files = files; // Assign files to the hidden input
                        // Manually trigger the 'change' event handler
                        const event = new Event('change');
                        input.dispatchEvent(event);
                    }
                });
            });
        });
    </script>
</body>
</html>

